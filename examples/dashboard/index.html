<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Protocol // Agent Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');
        
        body {
            font-family: 'Fira Code', monospace;
            background-color: #0D0D0D;
            color: #00FF41;
        }
        
        .scan-line {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        .terminal-box {
            border: 1px solid #333;
            background: rgba(13, 13, 13, 0.9);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
        }

        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        .progress-bar {
            background: #1a1a1a;
            height: 8px;
            width: 100%;
        }
        .progress-fill {
            background: #00FF41;
            height: 100%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="h-screen overflow-hidden p-6 flex flex-col gap-6">
    <div class="scan-line"></div>

    <!-- Header -->
    <header class="flex justify-between items-end border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold tracking-tighter">PROXY PROTOCOL <span class="text-xs align-top opacity-50">v1.0</span></h1>
            <p class="text-sm text-gray-500">AGENT_ID: <span class="text-white" id="agent-id">connecting...</span></p>
        </div>
        <div class="text-right">
            <div class="text-xs text-gray-500">NETWORK STATUS</div>
            <div class="text-sm flex items-center gap-2 justify-end">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></span> <span id="status-text">OFFLINE</span>
            </div>
        </div>
    </header>

    <!-- KPI Grid -->
    <div class="grid grid-cols-4 gap-6">
        <div class="terminal-box p-4">
            <div class="text-xs text-gray-500 mb-1">TOTAL SPEND (24H)</div>
            <div class="text-2xl font-bold"><span id="metric-spend">0</span> <span class="text-sm font-normal">SATS</span></div>
            <div class="text-xs text-green-700 mt-2">â–² Live</div>
        </div>
        <div class="terminal-box p-4">
            <div class="text-xs text-gray-500 mb-1">SUCCESS RATE</div>
            <div class="text-2xl font-bold"><span id="metric-rate">0</span><span class="text-sm font-normal">%</span></div>
            <div class="progress-bar mt-3"><div id="metric-rate-bar" class="progress-fill" style="width: 0%"></div></div>
        </div>
        <div class="terminal-box p-4">
            <div class="text-xs text-gray-500 mb-1">ACTIVE ESCROWS</div>
            <div class="text-2xl font-bold text-yellow-400" id="metric-escrow">0</div>
            <div class="text-xs text-gray-500 mt-2">Locked Funds</div>
        </div>
        <div class="terminal-box p-4">
            <div class="text-xs text-gray-500 mb-1">REPUTATION</div>
            <div class="text-2xl font-bold" id="metric-rep">Unknown</div>
            <div class="text-xs text-gray-500 mt-2">Tier Access</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex flex-1 gap-6 min-h-0">
        
        <!-- Live Feed -->
        <div class="terminal-box flex-1 flex flex-col p-4">
            <div class="flex justify-between mb-4">
                <h2 class="font-bold">LIVE TASK FEED</h2>
                <span class="text-xs border border-green-900 px-2 py-0.5 rounded">WEBSOCKET</span>
            </div>
            <div id="log-feed" class="flex-1 overflow-y-auto font-mono text-sm space-y-2 pr-2">
                <!-- Logs injected via JS -->
            </div>
        </div>

        <!-- Configuration -->
        <div class="w-1/3 flex flex-col gap-6">
            <div class="terminal-box p-4 flex-1">
                <h2 class="font-bold mb-4">CONNECTION SETTINGS</h2>
                <div class="space-y-4 text-sm">
                    <input type="text" id="api-url" placeholder="API URL (e.g. http://localhost:3000/v1)" class="w-full bg-black border border-gray-700 p-2 text-green-500 mb-2">
                    <input type="password" id="api-key" placeholder="API Key (sk_...)" class="w-full bg-black border border-gray-700 p-2 text-green-500">
                    <button onclick="connect()" class="w-full border border-green-600 hover:bg-green-900 py-2">CONNECT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const feed = document.getElementById('log-feed');
        let pollingInterval = null;

        function addLog(level, message) {
            const row = document.createElement('div');
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            let color = 'text-gray-400';
            if (level === 'SUCCESS') color = 'text-green-400';
            if (level === 'WARN') color = 'text-yellow-400';
            if (level === 'TX') color = 'text-blue-400';

            row.innerHTML = `<span class="text-gray-600">[${time}]</span> <span class="${color} font-bold">${level}</span> ${message}`;
            feed.prepend(row);
            if (feed.children.length > 50) feed.lastChild.remove();
        }

        async function connect() {
            const baseUrl = document.getElementById('api-url').value || 'http://localhost:3000/v1';
            const apiKey = document.getElementById('api-key').value;

            addLog('INFO', `Connecting to ${baseUrl}...`);

            try {
                // 1. Fetch Ticker (Test Connection)
                const res = await fetch(`${baseUrl}/market/ticker`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                // 2. Update UI
                document.getElementById('status-dot').classList.remove('bg-gray-500');
                document.getElementById('status-dot').classList.add('bg-green-500', 'blink');
                document.getElementById('status-text').innerText = "ONLINE";
                document.getElementById('agent-id').innerText = apiKey.substring(0, 12) + "...";
                
                addLog('SUCCESS', `Connected to Network. Status: ${data.status}`);
                
                // 3. Start Polling for Agent Stats (Mock Endpoint for Demo)
                // In a real app, you would hit /agent/profile
                startPolling(baseUrl, apiKey);

            } catch (e) {
                addLog('WARN', `Connection Failed: ${e.message}`);
                document.getElementById('status-dot').classList.add('bg-red-500');
                document.getElementById('status-text').innerText = "ERROR";
            }
        }

        function startPolling(url, key) {
            if (pollingInterval) clearInterval(pollingInterval);
            
            // Mocking the "Live Feed" update since we don't have a real WS open in this demo file
            // But this structure allows you to swap it for a real fetch() easily.
            pollingInterval = setInterval(() => {
                // Fetch active tasks...
                // const tasks = await fetch(`${url}/tasks/active`...)
                
                // For now, simulate activity to keep the dashboard looking alive
                const r = Math.random();
                if (r > 0.7) {
                   addLog('TX', 'Heartbeat received from LND node.');
                }
            }, 3000);
        }
    </script>
</body>
</html>
