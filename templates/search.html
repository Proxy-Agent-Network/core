<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <title>Command | Proxy Agent Network</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;700&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <script src="{{ url_for('static', filename='js/translations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/language-engine.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-engine.js') }}"></script>

    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || localStorage.getItem('selectedTheme');
            if (savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); }
        })();
    </script>

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: var(--bg); }
        /* Remove the margin under the HUD specifically for this app view */
        .mission-hud { margin-bottom: 0 !important; z-index: 100; position: relative; }
        
        .iframe-container { flex-grow: 1; width: 100%; position: relative; }
        iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>

    {% include 'components/header.html' %}
    {% include 'components/settings_modal.html' %}

    <div class="iframe-container">
        <iframe src="http://localhost:8501/?embed=true" id="agent-terminal"></iframe>
    </div>

    {% include 'components/footer.html' %}

    <script>
        let rawSatsBalance = {{ balance|default(20000) }};
        let currentUnit = localStorage.getItem('currencyUnit') || 'SATS';
        const RATES = { SATS: 1, BTC: 0.00000001, USD: 0.00065, CAD: 0.00088, CNY: 0.0047, TWD: 0.021, EUR: 0.00060, GBP: 0.00051, JPY: 0.1, MXN: 0.012, KRW: 0.90, AUD: 0.0010 };

        function updateBalanceDisplay() {
            const el = document.getElementById('hud-balance');
            if (!el) return;
            let val = rawSatsBalance * (RATES[currentUnit] || 1);
            if (currentUnit === 'SATS') el.innerText = Math.floor(val).toLocaleString() + " SATS";
            else if (currentUnit === 'BTC') el.innerText = val.toFixed(8) + " BTC";
            else el.innerText = val.toLocaleString('en-US', {style: 'currency', currency: currentUnit});
        }

        function changeUnit(unit) {
            currentUnit = unit;
            localStorage.setItem('currencyUnit', unit);
            const label = document.getElementById('unit-label');
            if(label) label.innerText = unit;
            updateBalanceDisplay();
        }

        function updateNetworkStats() {
            fetch('/api/v1/network/stats').then(r => r.json()).then(data => {
                const healthSpan = document.getElementById('health-peers');
                if (healthSpan) {
                    const lang = localStorage.getItem('selectedLanguage') || 'en';
                    let dict = window.TRANSLATIONS;
                    const t = (dict && dict[lang]) ? dict[lang] : (dict && dict['en'] ? dict['en'] : {});
                    if (data.peers > 0) { 
                        healthSpan.innerHTML = `â— ${data.peers} ${t.status_connected || 'CONNECTED'}`; 
                        healthSpan.style.color = "#2ecc71"; 
                    } else { 
                        healthSpan.innerHTML = `â— 0 ${t.status_peers || 'PEERS'} (${t.status_searching || 'SEARCHING'})`; 
                        healthSpan.style.color = "#f1c40f"; 
                    }
                }
            }).catch(e => {
                const healthSpan = document.getElementById('health-peers');
                if(healthSpan) { healthSpan.innerHTML = `â— 0 PEERS (SEARCHING)`; healthSpan.style.color = "#f1c40f"; }
            });
        }

        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('active'); }
        window.onclick = function(event) { if (event.target == document.getElementById('settingsModal')) { document.getElementById('settingsModal').classList.remove('active'); } }

        let audioMuted = localStorage.getItem('audioMuted') === 'true';
        function toggleMute() {
            audioMuted = !audioMuted; localStorage.setItem('audioMuted', audioMuted);
            const btn = document.getElementById('mute-btn'); const icon = document.getElementById('mute-icon');
            if(btn && icon) {
                if (audioMuted) { btn.style.color = '#e74c3c'; btn.style.borderColor = '#e74c3c'; icon.className = 'fas fa-volume-mute'; } 
                else { btn.style.color = ''; btn.style.borderColor = ''; icon.className = 'fas fa-volume-up'; }
            }
        }
        function adjustVolume(val) { localStorage.setItem('audioVolume', val); }

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof ThemeEngine !== 'undefined') ThemeEngine.init('settings-theme-selector');
            if (typeof LanguageEngine !== 'undefined') {
                LanguageEngine.init('language-selector');
                const langSelect = document.getElementById('language-selector');
                if(langSelect) langSelect.addEventListener('change', () => { setTimeout(updateNetworkStats, 50); });
            }
            
            // ðŸŒŸ INITIALIZE CURRENCY LABEL ON LOAD ðŸŒŸ
            const unitLabel = document.getElementById('unit-label');
            if (unitLabel) unitLabel.innerText = currentUnit;
            updateBalanceDisplay();
            
            updateNetworkStats();
            setInterval(updateNetworkStats, 10000);

            // ðŸŒŸ THE CROSS-ORIGIN BRIDGE TRANSMITTER ðŸŒŸ
            setInterval(() => {
                const iframe = document.getElementById('agent-terminal');
                if (iframe && iframe.contentWindow) {
                    const payload = {
                        theme: localStorage.getItem('theme') || localStorage.getItem('selectedTheme') || 'business',
                        language: localStorage.getItem('selectedLanguage') || 'en',
                        currency: localStorage.getItem('currencyUnit') || 'SATS',
                        translations: window.TRANSLATIONS || {},
                        origin: window.location.origin 
                    };
                    iframe.contentWindow.postMessage(payload, '*');
                }
            }, 500);
        });
    </script>
</body>
</html>