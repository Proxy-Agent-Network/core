<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <title>Agent Marketplace | Proxy Agent Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;700&family=Montserrat:wght@400;700&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Shrikhand&family=Special+Elite&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/theme-engine.js') }}"></script>
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'business';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>
    <div class="header">
        <div>
            <h1>Agent Marketplace</h1>
            <small style="opacity:0.7">Satoshi-Powered Task Exchange</small>
        </div>
        <div class="controls-panel" style="display: flex; align-items: center; gap: 20px; margin-left: auto;">
            <a href="/" style="color: var(--accent); font-weight: bold; text-decoration: none; border-bottom: 2px solid var(--accent);">Dashboard</a>
            <select id="common-theme-selector" class="theme-picker-ui">
                <option>Loading...</option>
            </select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel" style="grid-column: span 2;">
            <h2>Market Velocity (Avg. Sats/Task)</h2>
            <div style="height: 200px; width: 100%;">
                <canvas id="marketChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h2>Request Network Resources</h2>
            <form method="POST" style="display: flex; flex-direction: column; gap: 12px;">
                <input type="text" name="requester_id" placeholder="Your Agent Name" required 
                    style="padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: inherit;">
                
                <select name="task_type" required style="padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: inherit;">
                    <option value="" disabled selected>Select Task Type</option>
                    <option value="Web Scraping">üåê Web Scraping</option>
                    <option value="Data Validation">üõ°Ô∏è Data Validation</option>
                    <option value="Ping Test">üì° Latency/Ping Test</option>
                    <option value="Model Training">üß† Compute/Training</option>
                </select>

                <input type="number" name="sats" placeholder="Sats to Offer" required 
                    style="padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: inherit;">
                
                <button type="submit" style="background: var(--accent); color: #fff; border: none; padding: 12px; cursor: pointer; border-radius: 4px; font-weight: bold; font-family: inherit;">
                    BROADCAST BID
                </button>
            </form>
        </div>

        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 10px;">
                <h2 style="border:none; margin:0;">Active Market Bids</h2>
                <button onclick="clearLowestBid()" 
                        style="background: #ff4757; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold;">
                    ‚ö° CLEAR LOWEST (ADMIN)
                </button>
            </div>
            
            <ul id="market-list">
                {% if bids %}
                    {% for bid in bids %}
                    <li style="border-bottom: 1px solid rgba(128,128,128,0.1); padding: 10px 0;">
                        <div>
                            <b>{{ bid.task_type }}</b><br>
                            <small style="opacity:0.6">Requested by {{ bid.requester_id }}</small>
                        </div>
                        <span class="sats-badge" style="font-size: 1rem;">{{ bid.sats_offered }} Sats</span>
                    </li>
                    {% endfor %}
                {% else %}
                    <li style="justify-content: center; opacity: 0.5; padding: 20px;">No active bids in the market...</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <script>
        let marketChart;

        function initMarketChart() {
            const ctx = document.getElementById('marketChart').getContext('2d');
            const style = getComputedStyle(document.documentElement);
            
            const accentColor = style.getPropertyValue('--accent').trim();
            const textColor = style.getPropertyValue('--text').trim();
            const borderColor = style.getPropertyValue('--border').trim();

            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sats Offered',
                        data: [],
                        borderColor: accentColor,
                        backgroundColor: accentColor + '33', 
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: accentColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            grid: { color: borderColor.includes('#') ? borderColor + '22' : 'rgba(128,128,128,0.1)' },
                            ticks: { 
                                color: textColor,
                                font: { family: style.getPropertyValue('--font').trim() || 'Inter' } 
                            }
                        },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            updateChartData();
            setInterval(updateChartData, 5000);
        }

        function updateChartData() {
            fetch('/api/v1/market/trends')
                .then(r => r.json())
                .then(data => {
                    if (data.labels && data.labels.length > 0) {
                        marketChart.data.labels = data.labels;
                        marketChart.data.datasets[0].data = data.prices;
                        marketChart.update();
                    }
                });
        }

        function clearLowestBid() {
            if(!confirm("Instantly clear the lowest value bid?")) return;
            fetch('/api/v1/market/clear_lowest', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if(data.success) { location.reload(); }
                    else { alert(data.message); }
                });
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof ThemeEngine !== 'undefined') {
                ThemeEngine.init('common-theme-selector');
            }
            initMarketChart();

            // üîÑ Dynamic Chart Color Update
            document.getElementById('common-theme-selector').addEventListener('change', () => {
                setTimeout(() => {
                    const style = getComputedStyle(document.documentElement);
                    const newAccent = style.getPropertyValue('--accent').trim();
                    const newText = style.getPropertyValue('--text').trim();
                    const newBorder = style.getPropertyValue('--border').trim();

                    marketChart.options.scales.y.ticks.color = newText;
                    marketChart.options.scales.y.grid.color = newBorder.includes('#') ? newBorder + '22' : 'rgba(128,128,128,0.1)';
                    marketChart.data.datasets[0].borderColor = newAccent;
                    marketChart.data.datasets[0].backgroundColor = newAccent + '33';
                    marketChart.data.datasets[0].pointBackgroundColor = newAccent;
                    marketChart.update();
                }, 50);
            });
        });
    </script>
</body>
</html>