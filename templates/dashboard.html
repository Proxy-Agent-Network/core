<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | Proxy Agent Network</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;700&family=Montserrat:wght@400;700&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Shrikhand&family=Special+Elite&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'business';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>

    <div id="xp-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="border:none; margin:0;">Session XP Ledger</h2>
                <button onclick="toggleXPModal()" style="padding:5px 15px; cursor:pointer; background:var(--accent); color:#fff; border:none; border-radius:4px;">CLOSE</button>
            </div>
            <div id="xp-history-list">
                <div style="opacity:0.5; text-align:center; padding:20px;">No gains recorded this session...</div>
            </div>
        </div>
    </div>

    <div id="hack-overlay">
        <div class="glitch-container">
            <div class="glitch-text glitch-top">>>> SYSTEM BYPASS <<<</div>
            <div class="glitch-text glitch-bottom">>>> SYSTEM BYPASS <<<</div>
        </div>
        <div style="margin-top: 15px; color: #fff; font-size: 1.2rem;">
            BONUS_REWARD: <span style="color: #ffd700; font-weight:bold;">+30 XP (On next Task Completion)</span>
        </div>
    </div>

    <div class="header">
        <div>
            <h1>Mission Control</h1>
            <small style="opacity:0.7">Proxy Agent Network v1.3</small>
        </div>
        
        <div class="controls-panel">
            <div class="audio-rack">
                <button id="mute-btn" onclick="toggleMute()" style="background:none; border:none; cursor:pointer; font-size:1.1rem;">üîä</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" oninput="updateVolume(this.value)">
            </div>
            <select id="theme-selector" onchange="changeTheme(this.value)">
                <option value="business">üëî Business</option>
                <option value="cyberpunk">ü¶æ Cyberpunk</option>
                <option value="retro">üëæ Retro Arcade</option>
                <option value="deepsea">üåä Deep Sea</option>
                <option value="vampire">üßõ Vampire</option>
                <option value="paperback">üìú Paperback</option>
                <option value="groovy">üï∫ Groovy</option>
            </select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel">
            <h2>Active Telemetry</h2>
            <div id="node-list">Initializing...</div>
        </div>

        <div class="panel">
            <h2>Agent Clearance</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="rank-icon" style="font-size: 1.5rem;">üéñÔ∏è</span>
                <div id="level-info" style="font-size: 1.3rem;">Level 1</div>
            </div>
            <div class="xp-container" onclick="toggleXPModal()">
                <div id="xp-bar" class="xp-fill"></div>
                <div id="xp-text" class="xp-text">0 / 5000 XP</div>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.8; margin-top: 10px; font-weight: bold;">
                Status: <span id="rank-name" style="color: var(--accent)">Probationary Agent</span>
            </p>
        </div>

        <div class="panel" style="grid-column: span 2;">
            <h2>Recent Ledger Activity</h2>
            <ul id="task-list"><li>Syncing Ledger...</li></ul>
        </div>
    </div>

    <img id="magic-marvin" src="/static/images/magic_marvin_dance.webp" alt="Magic Marvin">

    <script>
        let isMuted = localStorage.getItem('muted') === 'true';
        let globalVolume = localStorage.getItem('volume') || 0.5;
        let xpHistorian = [];
        
        let previousServerXP = parseFloat(localStorage.getItem('lastServerXP')) || 0; 
        let sessionBonusXP = parseFloat(localStorage.getItem('sessionBonusXP')) || 0;
        let stagedBonus = 0;

        const sounds = {
            coin1: new Audio('/static/audio/Coin_Tier1.mp3'),
            coin2: new Audio('/static/audio/Coin_Tier2.mp3'),
            coin3: new Audio('/static/audio/Coin_Tier3.mp3'),
            levelup: new Audio('/static/audio/Leveled_Up_Strings.mp3'),
            marvin: new Audio('/static/audio/marvin_laughing.mp3'),
            hack: new Audio('/static/audio/Secret_PowerUp1.mp3') 
        };

        function updateVolume(val) {
            globalVolume = val;
            localStorage.setItem('volume', val);
            Object.values(sounds).forEach(s => s.volume = isMuted ? 0 : val);
        }

        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('muted', isMuted);
            document.getElementById('mute-btn').innerText = isMuted ? 'üîá' : 'üîä';
            updateVolume(globalVolume);
        }

        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const marvin = document.getElementById('magic-marvin');
            if (marvin) marvin.style.display = (theme === 'business' || theme === 'paperback') ? 'none' : 'block';
            localStorage.setItem('theme', theme);
        }

        function toggleXPModal() {
            const modal = document.getElementById('xp-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function fetchStatus() {
            fetch('/debug/node_status').then(r => r.json()).then(data => {
                const nodeId = Object.keys(data)[0];
                if (!nodeId) return;
                const node = data[nodeId];
                
                let currentServerXP = node.xp || 0;
                
                // üõë HANDLE INITIAL LOAD (Empty Cache)
                if (localStorage.getItem('lastServerXP') === null) {
                    previousServerXP = currentServerXP;
                    localStorage.setItem('lastServerXP', currentServerXP);
                }

                // üõë RESET DETECTION
                if (currentServerXP < previousServerXP) {
                    sessionBonusXP = 0; stagedBonus = 0; xpHistorian = [];
                    localStorage.setItem('sessionBonusXP', 0);
                    localStorage.setItem('lastXP', 0);
                    localStorage.setItem('lastServerXP', 0);
                    previousServerXP = 0;
                }

                // üéØ GAIN DETECTION
                if (currentServerXP > previousServerXP) {
                    const baseGain = currentServerXP - previousServerXP;
                    const timestamp = new Date().toLocaleTimeString([], { hour12: false });
                    
                    // üö® CRITICAL FIX: Fetch tasks immediately to get REAL Source ID
                    fetch('/debug/view_tasks').then(r => r.json()).then(tasks => {
                        // Assuming API returns oldest first, the new task is at the END
                        const latestTask = tasks[tasks.length - 1]; 
                        const source = latestTask ? latestTask.task_id : "Inbound Reward";

                        // Secret Reward
                        if (stagedBonus > 0) {
                            xpHistorian.unshift({ source: `Secret Bypass Reward (${source})`, gain: stagedBonus, time: timestamp, type: 'secret' });
                            sessionBonusXP += stagedBonus;
                            stagedBonus = 0;
                        }

                        // Rubber Band
                        let effectiveTotal = currentServerXP + sessionBonusXP;
                        if ((Math.floor(effectiveTotal / 5000) + 1) < 5) {
                            xpHistorian.unshift({ source: `Rubber-Band Boost (${source})`, gain: baseGain, time: timestamp, type: 'bonus' });
                            sessionBonusXP += baseGain;
                        }

                        // Base Task
                        xpHistorian.unshift({ source: source, gain: baseGain, time: timestamp, type: 'base' });
                        
                        localStorage.setItem('sessionBonusXP', sessionBonusXP);
                        if (xpHistorian.length > 30) xpHistorian.splice(30);
                        updateHistoryUI();
                        updateTasks(); // Update UI list now
                    });
                    
                    // Sound Logic
                    let displayTotal = currentServerXP + sessionBonusXP;
                    let previousDisplayTotal = previousServerXP + (sessionBonusXP - baseGain); 
                    if ((Math.floor(displayTotal / 5000) + 1) > (Math.floor(previousDisplayTotal / 5000) + 1)) {
                        sounds.levelup.play().catch(e => {});
                        summonMarvin();
                    } else {
                        if (baseGain >= 100) sounds.coin3.play().catch(e => {});
                        else if (baseGain >= 50) sounds.coin2.play().catch(e => {});
                        else sounds.coin1.play().catch(e => {});
                    }
                } else {
                    updateTasks(); // Regular update if no gain
                }

                // UI UPDATE
                let displayTotalXP = currentServerXP + sessionBonusXP;
                localStorage.setItem('lastXP', displayTotalXP);
                localStorage.setItem('lastServerXP', currentServerXP); 
                previousServerXP = currentServerXP;

                const currentLevel = Math.floor(displayTotalXP / 5000) + 1;
                const xpTowardsNext = displayTotalXP % 5000;
                const percent = (xpTowardsNext / 5000) * 100;

                let rank = "Probationary Agent"; let icon = "üéñÔ∏è";
                if (currentLevel >= 15) { rank = "Diamond Executive"; icon = "üíé"; }
                else if (currentLevel >= 10) { rank = "Platinum Lead"; icon = "üèÜ"; }
                else if (currentLevel >= 5) { rank = "Gold Veteran"; icon = "ü•á"; }
                else if (currentLevel >= 2) { rank = "Bronze Specialist"; icon = "ü•â"; }

                document.getElementById('level-info').innerText = `Level ${currentLevel} Operator`;
                document.getElementById('xp-bar').style.width = `${percent}%`;
                document.getElementById('xp-text').innerText = `${xpTowardsNext} / 5000 XP`;
                document.getElementById('rank-name').innerText = rank;
                document.getElementById('rank-icon').innerText = icon;
                document.getElementById('node-list').innerHTML = `<div><b>${nodeId}</b> <span style="color:var(--accent); float:right;">‚óè ONLINE</span></div>`;
            });
        }

        function updateHistoryUI() {
            const list = document.getElementById('xp-history-list');
            list.innerHTML = xpHistorian.map(entry => {
                let indent = "";
                let rowClass = "history-item"; 
                let typeClass = "";
                
                if (entry.type === 'secret') {
                    indent = "‚îî‚îÄ ‚ö° ";
                    rowClass += " nested-reward";
                    typeClass = "type-secret";
                } else if (entry.type === 'bonus') {
                    indent = "‚îî‚îÄ üìà ";
                    rowClass += " nested-reward";
                    typeClass = "type-bonus";
                } else {
                    typeClass = "type-base";
                }

                return `<div class="${rowClass} ${typeClass}">
                    <span class="history-label">
                        ${indent ? indent : `[${entry.time}] `}<i>${entry.source}</i>
                    </span>
                    <b class="history-amount">+${entry.gain} XP</b>
                </div>`;
            }).join('');
        }

        function updateTasks() {
            fetch('/debug/view_tasks').then(r => r.json()).then(tasks => {
                const list = document.getElementById('task-list');
                // üéØ FIX: Reverse array to show Newest First in UI
                const recentTasks = tasks.slice().reverse().slice(0, 6);
                list.innerHTML = recentTasks.map(t => {
                    const pay = t.payout || t.bid_sats || t.value || 0;
                    let tierClass = t.task_id === 'KONAMI-DEV-CHEAT' ? 'tier-hack' : (pay >= 5000 ? 'tier-3' : '');
                    return `<li class="${tierClass}"><span><b>${t.task_id}</b></span><span class="sats-badge">+${pay} Sats</span></li>`;
                }).join('');
            });
        }

        const marvin = document.getElementById('magic-marvin');
        marvin.addEventListener('dblclick', () => { sounds.marvin.currentTime = 0; sounds.marvin.play(); marvin.style.transform = "scale(1.2) rotate(360deg)"; setTimeout(() => marvin.style.transform = "none", 500); });
        function summonMarvin() { if(marvin.style.display !== 'none') { marvin.style.bottom = "20px"; setTimeout(() => marvin.style.bottom = "-300px", 5000); } }

        let konamiIndex = 0;
        const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        document.addEventListener('keydown', (e) => {
            if (e.key === konamiCode[konamiIndex]) { konamiIndex++; if (konamiIndex === konamiCode.length) { triggerCheat(); konamiIndex = 0; } } else { konamiIndex = 0; }
        });

        function triggerCheat() {
            sounds.hack.play();
            const overlay = document.getElementById('hack-overlay');
            overlay.style.display = 'flex';
            stagedBonus = 30; 
            fetch('/api/v1/tasks/complete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ task_id: "KONAMI-DEV-CHEAT", node_id: "NODE-ADMIN-001", payout: 300 })})
            .then(() => setTimeout(() => overlay.style.display = 'none', 3000));
        }

        // üéØ FIX: Faster polling (1s) to catch rapid stress test updates
        setInterval(fetchStatus, 1000);
        
        window.onload = () => {
            document.getElementById('volume-slider').value = globalVolume;
            document.getElementById('mute-btn').innerText = isMuted ? 'üîá' : 'üîä';
            const savedTheme = localStorage.getItem('theme') || 'business';
            document.getElementById('theme-selector').value = savedTheme;
            changeTheme(savedTheme);
            updateVolume(globalVolume);
            
            let savedLastXP = parseFloat(localStorage.getItem('lastXP')) || 0;
            if (savedLastXP > 0) {
                 const percent = (savedLastXP % 5000) / 50;
                 document.getElementById('xp-bar').style.width = `${percent}%`;
                 document.getElementById('xp-text').innerText = `${savedLastXP % 5000} / 5000 XP`;
                 document.getElementById('level-info').innerText = `Level ${Math.floor(savedLastXP / 5000) + 1} Operator`;
            }
        };
    </script>
</body>
</html>