<!DOCTYPE html>
<html lang="en" data-theme="business"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | Proxy Agent Network</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;700&family=Montserrat:wght@400;700&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Shrikhand&family=Special+Elite&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

    <style>
        /* üé® THEME DEFINITIONS */
        :root {
            /* Fallback/Base variables */
            --h1-size: 1.5rem;
            --pill-font-size: 0.8rem;
        }

        [data-theme="business"] { 
            --bg: #f4f7f6; --card-bg: #fff; --text: #2c3e50; 
            --accent: #2980b9; --border: #dcdde1; 
            --font: 'Inter', sans-serif; 
        }

        [data-theme="retro"] { 
            --bg: #2b033d; --card-bg: #4c066b; --text: #00ffff; 
            --accent: #ff00ff; --border: #ff00ff; 
            --font: 'Press Start 2P', cursive; 
            --h1-size: 1.0rem; --pill-font-size: 0.5rem; /* Pixel font adjustments */
        }

        [data-theme="groovy"] { 
            --bg: #fdf5e6; --card-bg: #e1d5e7; --text: #2f4f4f; 
            --accent: #ff69b4; --border: #8fbc8f; 
            --font: 'Shrikhand', cursive; 
        }

        [data-theme="paperback"] { 
            --bg: #f5e6d3; --card-bg: #fff; --text: #3b3b3b; 
            --accent: #2c3e50; --border: #bca08d; 
            --font: 'Special Elite', cursive; 
        }

        [data-theme="cyberpunk"] { 
            --bg: #000; --card-bg: #111; --text: #fee715; 
            --accent: #ea00d9; --border: #fee715; 
            --font: 'Orbitron', sans-serif; 
        }

        [data-theme="vampire"] { 
            --bg: #1a0000; --card-bg: #2a0000; --text: #8b0000; 
            --accent: #ffd700; --border: #4a0000; 
            --font: 'UnifrakturMaguntia', serif; 
        }

        [data-theme="deepsea"] { 
            --bg: #001219; --card-bg: #005f73; --text: #94d2bd; 
            --accent: #ee9b00; --border: #0a9396; 
            --font: 'Montserrat', sans-serif; 
        }

        /* Core Layout */
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        /* ------------------------------------------------------- */
        /* üïµÔ∏è HACKER OVERLAY (Always Matrix Style) */
        /* ------------------------------------------------------- */
        #hack-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 10, 0, 0.98);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            font-family: 'Courier Prime', monospace;
        }

        .glitch-text {
            font-size: 4rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 4px 4px #00ff00;
            animation: glitch 0.2s infinite;
        }

        @keyframes glitch {
            0% { text-shadow: 2px 2px #0f0; transform: translate(0,0); }
            20% { text-shadow: -2px -2px #f00; transform: translate(-2px, 2px); }
            40% { text-shadow: 2px -2px #0f0; transform: translate(2px, -2px); }
            60% { text-shadow: -2px 2px #f00; transform: translate(-2px, 2px); }
            80% { text-shadow: 2px 2px #0f0; transform: translate(0,0); }
            100% { text-shadow: -2px -2px #0f0; transform: translate(2px, -2px); }
        }

        /* ------------------------------------------------------- */
        /* UI COMPONENTS */
        /* ------------------------------------------------------- */
        .header {
            width: 100%; max-width: 900px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px; margin-bottom: 30px;
            text-transform: uppercase;
        }
        
        h1 { margin: 0; font-size: var(--h1-size); }

        /* THEME SELECTOR */
        select {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px 10px;
            font-family: var(--font);
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            box-shadow: 2px 2px var(--border);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            width: 100%; max-width: 900px;
        }

        .panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 4px 4px 0px var(--border); /* Retro shadow feel */
            transition: all 0.5s ease;
        }

        .panel h2 {
            margin-top: 0;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 10px;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* XP BAR */
        .xp-container {
            background: rgba(0,0,0,0.1); /* Neutral */
            border: 2px solid var(--border);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-top: 15px;
        }
        .xp-fill {
            background: var(--accent);
            height: 100%; width: 0%;
            transition: width 0.5s ease-out;
        }
        .xp-text {
            position: absolute; width: 100%; text-align: center; top: 2px;
            font-size: var(--pill-font-size); 
            color: var(--text);
            filter: contrast(200%); /* Ensure readability */
            font-weight: bold;
        }

        /* TASK LIST & TIERS */
        ul { list-style: none; padding: 0; }
        li {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        /* Sats Badge */
        .sats-badge {
            background: var(--bg);
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--accent);
            font-weight: bold;
            border: 1px solid var(--border);
            font-size: var(--pill-font-size);
        }

        /* Tier Indicators (Using Accent/Border logic) */
        .tier-3 { color: var(--accent); font-weight: bold; }
        .tier-hack { background: rgba(0, 255, 0, 0.1); border-left: 4px solid #0f0; }

        /* MAGIC MARVIN */
        #magic-marvin {
            position: fixed; bottom: -300px; right: 20px;
            width: 140px; cursor: pointer; z-index: 100;
            transition: bottom 1s cubic-bezier(0.68, -0.55, 0.27, 1.55), transform 0.5s;
            filter: drop-shadow(0 0 5px var(--accent));
        }
    </style>
</head>
<body>

    <div id="hack-overlay">
        <div class="glitch-text">>>> SYSTEM BYPASS <<<</div>
        <div style="margin-top: 30px; font-size: 1.8rem; color: #0f0;">
            ROOT_ACCESS: <span style="background:#0f0; color:#000; padding: 2px 5px;">GRANTED</span>
        </div>
        <div style="margin-top: 15px; color: #fff; font-size: 1.2rem;">
            BONUS_REWARD: <span style="color: #ffd700; font-weight:bold;">+30 XP</span>
        </div>
    </div>

    <div class="header">
        <div>
            <h1>Mission Control</h1>
            <small style="opacity:0.7">Proxy Agent Network v1.2</small>
        </div>
        
        <div>
            <select id="theme-selector" onchange="changeTheme(this.value)">
                <option value="business">üëî Business</option>
                <option value="cyberpunk">ü¶æ Cyberpunk</option>
                <option value="retro">üëæ Retro Arcade</option>
                <option value="deepsea">üåä Deep Sea</option>
                <option value="vampire">üßõ Vampire</option>
                <option value="paperback">üìú Paperback</option>
                <option value="groovy">üï∫ Groovy</option>
            </select>
            <div style="margin-top:5px; text-align:right; font-size:0.7rem; opacity:0.8;">
                ‚óè ONLINE
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel">
            <h2>Active Telemetry</h2>
            <div id="node-list">Initializing Uplink...</div>
        </div>

        <div class="panel">
            <h2>Agent Clearance</h2>
            <div id="level-info" style="font-size: 1.3rem;">Level 1</div>
            <div class="xp-container">
                <div id="xp-bar" class="xp-fill"></div>
                <div id="xp-text" class="xp-text">0 / 5000 XP</div>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;">
                Next Promotion: <span style="color: var(--accent)">Bronze Specialist</span>
            </p>
        </div>

        <div class="panel" style="grid-column: span 2;">
            <h2>Recent Ledger Activity</h2>
            <ul id="task-list">
                <li style="opacity:0.6">Waiting for blockchain sync...</li>
            </ul>
        </div>
    </div>

    <img id="magic-marvin" src="/static/images/magic_marvin_dance.webp" alt="Magic Marvin">

    <script>
        // -------------------------------------------------------
        // üé® THEME ENGINE
        // -------------------------------------------------------
        function changeTheme(theme) {
            // 1. Set the Data Attribute on HTML tag
            document.documentElement.setAttribute('data-theme', theme);
            
            // 2. Handle Marvin Visibility
            // Hidden in "Business" (Serious) and "Paperback" (Noir/Minimal)
            const marvin = document.getElementById('magic-marvin');
            if (marvin) {
                if (theme === 'business' || theme === 'paperback') {
                    marvin.style.display = 'none';
                } else {
                    marvin.style.display = 'block';
                }
            }
            
            // 3. Save preference
            localStorage.setItem('theme', theme);
        }

        // Restore Theme on Load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.getElementById('theme-selector').value = savedTheme;
            changeTheme(savedTheme);
        }

        // -------------------------------------------------------
        // ‚öôÔ∏è LOGIC & CONFIG
        // -------------------------------------------------------
        let previousXP = 0;

        // Audio Assets
        const sounds = {
            coin1: new Audio('/static/audio/Coin_Tier1.mp3'),
            coin2: new Audio('/static/audio/Coin_Tier2.mp3'),
            coin3: new Audio('/static/audio/Coin_Tier3.mp3'),
            levelup: new Audio('/static/audio/Leveled_Up_Strings.mp3'),
            marvin: new Audio('/static/audio/marvin_laughing.mp3'),
            hack: new Audio('/static/audio/Secret_PowerUp1.mp3') 
        };

        const marvin = document.getElementById('magic-marvin');
        if (marvin) {
            marvin.addEventListener('click', () => {
                sounds.marvin.play().catch(e => console.log(e));
                marvin.style.transform = "rotate(720deg) scale(1.2)";
                setTimeout(() => marvin.style.transform = "none", 1000);
            });
        }

        function summonMarvin() {
            if (!marvin || marvin.style.display === 'none') return; 
            marvin.style.bottom = "0px";
            setTimeout(() => marvin.style.bottom = "-300px", 4000);
        }

        function fetchStatus() {
            fetch('/debug/node_status')
                .then(r => r.json())
                .then(data => {
                    updateNodes(data);
                    updateTasks();
                });
        }

        function updateNodes(nodes) {
            const list = document.getElementById('node-list');
            const xpBar = document.getElementById('xp-bar');
            const xpText = document.getElementById('xp-text');
            const levelInfo = document.getElementById('level-info');

            const firstNodeId = Object.keys(nodes)[0];
            if (!firstNodeId) return;

            const node = nodes[firstNodeId];
            const streak = node.streak_days !== undefined ? node.streak_days : 0;
            const trust = node.trust_score !== undefined ? node.trust_score : 100;

            const currentLevel = Math.floor(node.xp / 5000) + 1;
            const currentXP = node.xp % 5000;
            const percent = (currentXP / 5000) * 100;

            levelInfo.innerText = `Level ${currentLevel} Operator`;
            xpBar.style.width = `${percent}%`;
            xpText.innerText = `${currentXP} / 5000 XP`;

            list.innerHTML = `
                <div style="font-size: 1.1rem; margin-bottom:5px;">
                    ${firstNodeId} <span style="color:var(--accent); float:right;">‚óè ONLINE</span>
                </div>
                <div style="display:flex; justify-content:space-between; opacity:0.8; font-size:0.9rem;">
                    <span>Streak: <b>${streak} Days</b></span>
                    <span>Trust: <b>${trust}%</b></span>
                </div>
            `;

            if (node.xp > previousXP) {
                const diff = node.xp - previousXP;
                if (diff >= 5000) sounds.levelup.play();
                else if (diff >= 50) sounds.coin3.play();
                else if (diff >= 20) sounds.coin2.play();
                else sounds.coin1.play();

                if (diff >= 100) summonMarvin();
            }
            previousXP = node.xp;
        }

        function updateTasks() {
            fetch('/debug/view_tasks')
                .then(r => r.json())
                .then(tasks => {
                    const list = document.getElementById('task-list');
                    if (tasks.length === 0) return;
                    
                    list.innerHTML = tasks.slice(0, 6).map(t => {
                        let tierClass = '';
                        if (t.task_id === 'KONAMI-DEV-CHEAT') tierClass = 'tier-hack';
                        else if (t.payout >= 5000) tierClass = 'tier-3'; 
                        
                        const id = t.task_id || t.id || 'Unknown';
                        const type = t.type || 'Generic';
                        const pay = t.payout || t.value || 0;

                        return `
                        <li class="${tierClass}">
                            <span>
                                <b>${id}</b> 
                                <span style="margin-left:15px; opacity:0.7">${type}</span>
                            </span>
                            <span class="sats-badge">+${pay} Sats</span>
                        </li>
                        `;
                    }).join('');
                });
        }

        // ü§´ KONAMI CODE LOGIC
        const konamiCode = [
            'ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 
            'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 
            'b', 'a'
        ];
        let konamiIndex = 0;

        document.addEventListener('keydown', function(e) {
            if (e.key === konamiCode[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === konamiCode.length) {
                    triggerCheatCode();
                    konamiIndex = 0;
                }
            } else {
                konamiIndex = 0;
            }
        });

        function triggerCheatCode() {
            sounds.hack.volume = 0.8;
            sounds.hack.play().catch(e => console.log(e));
            const overlay = document.getElementById('hack-overlay');
            overlay.style.display = 'flex';
            fetch('/api/v1/tasks/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    task_id: "KONAMI-DEV-CHEAT", 
                    node_id: "NODE-ADMIN-001",
                    payout: 300 
                })
            })
            .then(() => {
                setTimeout(() => {
                    overlay.style.display = 'none';
                    fetchStatus(); 
                }, 3000);
            });
        }

        setInterval(fetchStatus, 2000);
        window.onload = () => { summonMarvin(); fetchStatus(); };
    </script>
</body>
</html>