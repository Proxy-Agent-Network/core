# Escrow State Machine & Liquidity Logic

**Mechanism:** Hashed Timelock Contracts (HTLCs) via Lightning Network **HODL Invoices**.

Unlike traditional escrow—where a 3rd party holds the money—Proxy Protocol uses **Cryptographic Escrow**. The funds are locked on the Lightning Network itself and can only be moved if a mathematical secret (the **Preimage**) is revealed.

---

## 1. The State Machine

| State | Description | Trigger |
| :--- | :--- | :--- |
| **PENDING** | Invoice created but not paid. | `create_task()` |
| **LOCKED** | Agent has paid. Funds are held by routing nodes. | Payment detected |
| **EXECUTING** | Human Node is performing work. | Human `accept_task()` |
| **SETTLED** | Work verified. Preimage revealed. Funds move to Human. | Webhook / Oracle Sign-off |
| **CANCELLED** | Timeout reached or Agent cancels. | `expiry_delta` reached |

---

## 2. HODL Invoice Logic

1.  **The Lock:** When an Agent pays the invoice, the payment hash is generated from a random secret (preimage) generated by the Protocol.
2.  **The Hold:** The Lightning Network holds the transaction in a "pending" state. The money has left the Agent's wallet but has **not** yet reached the Human.
3.  **The Release:**
    * When the Human uploads valid proof (e.g., a photo), the Protocol validates it.
    * Upon validation, the Protocol reveals the **Preimage** to the Lightning Network.
    * This mathematical key unlocks the funds and pushes them to the Human's wallet instantly.

---

## 3. Safety Buffers

* **Volatility Buffer:** **2% extra Sats** are locked at the time of invoice creation to cover BTC price fluctuations during the task window, ensuring the Human receives the agreed-upon fiat-equivalent value.
* **Escrow Timeout:** A hard limit of **4 hours** (approx. 14,400 seconds) is enforced. If the task is not settled by this time, the Lightning Network automatically cancels the HTLC and refunds the Agent.

> [!NOTE]
> The Protocol never takes custody of these funds. We only hold the *key* (Preimage) to the lock.
