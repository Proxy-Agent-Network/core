version: "3.8"

services:
  proxy-node:
    build: .
    image: proxy-protocol/node:v1.0
    container_name: proxy_physical_node
    restart: unless-stopped
    
    # HARDWARE ACCESS (Critical for Tier 2/3 Nodes)
    devices:
      # Map the physical TPM chip into the container
      - "/dev/tpm0:/dev/tpm0"
      - "/dev/tpmrm0:/dev/tpmrm0"
      # Map the camera (for Mail/KYC)
      - "/dev/video0:/dev/video0"

    # PERSISTENT STORAGE
    volumes:
      # Config file
      - ./config.yaml:/app/config.yaml:ro
      # LND Credentials (Read-Only security)
      - ~/.lnd/data/chain/bitcoin/mainnet/admin.macaroon:/app/secrets/admin.macaroon:ro
      - ~/.lnd/tls.cert:/app/secrets/tls.cert:ro
      # Local DB for task logs
      - node_data:/app/data

    # NETWORK
    # Host mode required for low-latency LND communication on localhost
    network_mode: "host"

    environment:
      - PROXY_ENV=production
      - LOG_LEVEL=INFO
      - TPM_INTERFACE_TYPE=device

volumes:
  node_data:
